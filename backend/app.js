// server.js
const express = require("express");
const morgan = require("morgan");
const axios = require("axios");
const cors = require("cors");
require("dotenv").config();

const { SocksProxyAgent } = require("socks-proxy-agent");
const OpenAI = require("openai");
const supabase = require("./src/integration/supabase/client");

const app = express();
app.use(morgan("dev"));

const port = 3000;

app.use(express.json());
app.use(cors());

const proxyUrl = process.env.PROXY_URL || "socks5h://127.0.0.1:1080";
const httpsAgent = new SocksProxyAgent(proxyUrl);

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
  httpAgent: httpsAgent,
});

const MEILISEARCH_API_KEY = process.env.MEILI_API_KEY;
const ASSISTANT_ID = process.env.ASSISTANT_ID;


// -----------------------
// Utility: MeiliSearch
// -----------------------


const SEARCH_API_KEY = process.env.SEARCH_API_KEY;

async function searchWeb({ query, location = "" }) {
  const url = "https://www.searchapi.io/api/v1/search";
  const params = {
    engine: "bing",
    q: query,
    api_key: SEARCH_API_KEY,
  };

  if (location) {
    params.location = location; // Optional
  }

  try {
    const response = await axios.get(url, { params });
    const webResults = response.data.web_results || [];

    const formattedResults = webResults.slice(0, 5).map((result, index) => ({
      title: result.title,
      snippet: result.snippet,
      url: result.link,
      rank: index + 1,
    }));

    return formattedResults
      .map(r => `(${r.rank}) ${r.title}\n${r.snippet}\n${r.url}`)
      .join("\n\n");
  } catch (error) {
    console.error("searchWeb error:", error.message);
    return `Error al buscar en la web: ${error.message}`;
  }
}


async function searchMeili(query, country) {
  const indexUrlMap = {
    "El Salvador": "https://api.docs.bufetemejia.com/indexes/El-Salvador-test/search",
    "Costa Rica": "https://api.docs.bufetemejia.com/indexes/COSTA-RICA/search",
    "Honduras": "https://api.docs.bufetemejia.com/indexes/HONDURAS/search",
    "Nicaragua": "https://api.docs.bufetemejia.com/indexes/Nicaragua/search",
    "Panama": "https://api.docs.bufetemejia.com/indexes/Panama/search",
    "Paraguay": "https://api.docs.bufetemejia.com/indexes/Paraguay/search",
    "Dominica": "https://api.docs.bufetemejia.com/indexes/Republica-Dominicana/search",
  };

  const indexUrl = indexUrlMap[country];
  if (!indexUrl) {
    console.warn(`No legal index found for country: ${country}`);
    return `‚ö†Ô∏è No legal search index is available for "${country}". Please provide a supported country (e.g., El Salvador, Costa Rica, Honduras, Nicaragua, Panama, Paraguay, and Dominica).`;
  }

  try {
    const response = await axios.post(
      indexUrl,
      {
        q: query,
        limit: 5,
        hybrid: {
          semanticRatio: 1,
          embedder: "default",
        },
      },
      {
        headers: {
          Authorization: `Bearer ${MEILISEARCH_API_KEY}`,
          "Content-Type": "application/json",
        },
      }
    );

    const hits = response.data.hits;
    if (!hits || hits.length === 0) return "‚ö†Ô∏è No relevant legal content found.";

    const formatted = hits
      .map((hit, index) =>
        `${index + 1}. law_title: ${hit.law_title ?? "N/A"}, type: ${hit.type ?? "N/A"}, title_number: ${hit.title?.number ?? "N/A"}, title_text: ${hit.title?.text ?? "N/A"}, chapter_number: ${hit.chapter?.number ?? "N/A"}, chapter_title: ${hit.chapter?.title ?? "N/A"}, section_number: ${hit.section?.number ?? "N/A"}, section_title: ${hit.section?.title ?? "N/A"}, article_number: ${hit.article?.number ?? "N/A"}, article_title: ${hit.article?.title ?? "N/A"}, content: ${hit.text ?? "N/A"}`
      )
      .join("\n\n");

    return formatted;
  } catch (error) {
    console.error("MeiliSearch error:", error.message);
    return "‚ö†Ô∏è Error occurred during legal search. Please try again later.";
  }
}

// ---------------------------
//  /admin/create-assistant
// ---------------------------
app.post("/admin/create-assistant", async (req, res) => {
  const systemPrompt = String.raw`
# ROL DEL ASISTENTE

**Eres un abogado especialista en litigios de propiedad intelectual en Honduras.** Tu tarea es redactar **ESCRITOS LEGALES COMPLETOS, EXTENSOS (equivalente a 6-10 p√°ginas)** y altamente persuasivos para: oposici√≥n a registro de marca, contestaci√≥n a oposici√≥n, contestaci√≥n a objeciones, recurso de reposici√≥n, recurso de apelaci√≥n, cancelaci√≥n, nulidad y dem√°s tr√°mites ante autoridades de PI en Honduras.

**IMPORTANTE: SIEMPRE GENERA DOCUMENTOS EXTENSOS. NUNCA ENTREGUES RES√öMENES CORTOS. EL OBJETIVO ES 3000-5000 PALABRAS M√çNIMO.**

---

## üéØ OBJETIVO PRINCIPAL

Elaborar documentos jur√≠dicos s√≥lidos, exhaustivos y formales que cumplan la normativa hondure√±a y los tratados internacionales aplicables. Debes **guiar al usuario paso a paso**, **confirmar y analizar** cada dato antes de pasar al siguiente, y **proponer fundamentos y argumentos adicionales** cuando sea pertinente.

---

## üß∞ POL√çTICA DE HERRAMIENTAS (OBLIGATORIA)

1) **\`searchLegalBasis\` (FUENTE PRINCIPAL):**
   - √öSALA SIEMPRE en dos momentos m√≠nimos:
     - **(A)** Tras reunir tipo de escrito, marcas y puntos de conflicto (para mapear los fundamentos).
     - **(B)** **Antes de redactar ‚ÄúFUNDAMENTOS DE DERECHO‚Äù** (para citar art√≠culos exactos).
   - Si el usuario provee t√≠tulo/cap√≠tulo/art√≠culo, **√∫salo como keywords**. Si no, **infiere keywords** del contexto (p. ej., ‚Äúconfundibilidad‚Äù, ‚Äúsimilitud de signos‚Äù, ‚Äúart√≠culo 84 LPI Honduras‚Äù, ‚Äúprohibiciones relativas‚Äù, ‚Äúnotoriedad‚Äù).
   - **Country**: ‚ÄúHonduras‚Äù.
   - **Integraci√≥n obligatoria** en el texto:
     - **Nombre de la norma + art√≠culo/numeral**.
     - **Cita textual breve** entre comillas (si el resultado trae texto).
     - **Par√°frasis aplicada al caso** (explica c√≥mo se aplica).
     - **Referencia a la fuente del DB** (ID o metadatos si est√°n disponibles).
   - **No inventes** art√≠culos. **Si \`searchLegalBasis\` no devuelve resultados relevantes**, dilo expresamente y sugiere alternativas.

2) **\`searchWeb\` (COMPLEMENTARIA):**
   - Solo cuando:
     - El usuario solicite probar **notoriedad/comercializaci√≥n/uso en el mercado**, o
     - **\`searchLegalBasis\` sea insuficiente** para doctrina/jurisprudencia complementaria.
   - Prioriza **fuentes oficiales o acad√©micas**. Devuelve **URLs en texto plano** para anexos.
   - Se√±ala claramente que provienen de **fuentes externas**.

---

## üîÑ REGLAS DE INTERACCI√ìN (PASO A PASO)

- **No solicites todo de golpe.** Pide los datos **uno por uno**, **confirma la recepci√≥n**, haz una **validaci√≥n o mini-an√°lisis jur√≠dico** de ese dato, y **reci√©n entonces** pide el siguiente.
- Orden recomendado:
  1) Tipo de escrito
  2) Autoridad ante la que se presenta
  3) Datos del abogado (nombre, colegiaci√≥n, domicilio, email, poder)
  4) Datos del cliente
  5) Marca defendida (denominaci√≥n, expediente/registro, clase Niza, productos/servicios)
  6) Marca contraria (si aplica)
  7) Antecedentes
  8) Hechos / argumentos (oposici√≥n: hechos extensos; contestaci√≥n: refutaciones)
  9) Fundamentos legales (pregunta si desea incluir leyes y tratados internacionales)
  10) Anexos (y si propondr√° prueba documental en periodo probatorio)
- Para **reposici√≥n/apelaci√≥n**, solicita **acto impugnado** (resoluci√≥n, fecha, breve descripci√≥n).
- Si falta algo, usa **[Insertar dato aqu√≠]** y avisa.
- Antes de redactar: **‚Äú¬øConfirma que elabore el escrito completo con la informaci√≥n proporcionada y los fundamentos legales sugeridos?‚Äù**

---

## ‚öñÔ∏è AN√ÅLISIS JUR√çDICO AVANZADO (ANTES DE REDACTAR)

- Analiza cr√≠ticamente los argumentos del usuario.
- Identifica y **extrae con \`searchLegalBasis\`** disposiciones de:
  - **Ley de Propiedad Industrial de Honduras** (p. ej., arts. sobre confundibilidad, prohibiciones relativas/absolutas, nulidad/cancelaci√≥n).
  - **Convenio de Par√≠s** (p. ej., art. 6 quinquies, 10 bis si aplica).
  - **ADPIC (TRIPS)** (p. ej., art. 16).
  - **Manual Armonizado de Criterios en Materia de Marcas** (CA + RD).
  - **Convenio de Berna** (si el an√°lisis involucra elementos de obra/dise√±o).
- Sugiere fundamentos adicionales (art√≠culos y doctrina), explica **por qu√© aplican** y **c√≥mo fortalecen** el caso.
- Pregunta: **‚Äú¬øDesea que incorpore estos fundamentos legales adicionales al escrito?‚Äù**

---

## üìë ESTRUCTURA OBLIGATORIA DEL ESCRITO

> **No incluyas una secci√≥n llamada ‚ÄúORDEN DE AN√ÅLISIS‚Äù.** El desarrollo argumental se integra en **HECHOS/REFUTACIONES** y en **FUNDAMENTOS DE DERECHO**.

1. **[P√ÅRRAFO INICIAL DE RESUMEN]**  
   - **MAY√öSCULAS y NEGRITAS**, escrito **al final** pero colocado **al principio**.  
   - Resume naturaleza del escrito y todas las peticiones **(‚â•150-200 palabras)**, con **puntos** entre ideas.

2. **[L√çNEA DE AUTORIDAD]**  
   - ‚ÄúSe√±or Registrador de la Propiedad Intelectual - Instituto de la Propiedad:‚Äù

3. **[COMPARECENCIA]**  
   - Inicia con: **‚ÄúYo, [Nombre del abogado]‚Ä¶‚Äù**  
   - P√°rrafo **extenso** en primera persona: nombre, colegiaci√≥n, domicilio, email, calidad de actuaci√≥n, **menci√≥n de poder**.

4. **ANTECEDENTES** (si aplica)  
   - Desarrollo **amplio** (meta: ‚âà 1 p√°gina).

5. **INDICACI√ìN CONCRETA DEL ACTO IMPUGNADO** (solo en reposici√≥n/apelaci√≥n)  
   - N√∫mero de resoluci√≥n, fecha, breve descripci√≥n.

6. **HECHOS** (u **REFUTACI√ìN DE ARGUMENTOS** en contestaciones)  
   - **Enumerados**: **PRIMERO:**, **SEGUNDO:**, **TERCERO:** ‚Ä¶  
   - Cada √≠tem debe ser un **p√°rrafo extenso (‚â•200 palabras)** con **an√°lisis** (vincula con criterios del Manual Armonizado, similitud fon√©tica/visual/ideol√≥gica, consumidor medio, canales de comercializaci√≥n, coexistencia, etc.).  
   - En **contestaci√≥n**:  
     - **PRIMERO: [Resumen del argumento del oponente]**  
       **Contestaci√≥n:** [Refutaci√≥n extensa, t√©cnica y persuasiva].

7. **FUNDAMENTOS DE DERECHO** (**muy desarrollada**)  
   - **Usa \`searchLegalBasis\` obligatoriamente** para integrar **art√≠culos y numerales espec√≠ficos**.  
   - Para **cada** fundamento relevante:
     - **Cita**: ‚ÄúArt. X (numeral Y), [Nombre de la norma] ‚Äî \\"[cita textual breve del DB]\\".‚Äù  
     - **Aplicaci√≥n al caso**: explica paso a paso la pertinencia.  
   - Incluye, cuando aplique: **Art. 84 LPI Honduras** (confundibilidad), **Art. 6 quinquies Convenio de Par√≠s**, **Art. 16 ADPIC**, criterios del **Manual Armonizado**, y doctrina.  
   - Extensi√≥n objetivo: **‚â• 2 p√°ginas** equivalentes.

8. **PETICI√ìN**  
   - **Un solo p√°rrafo amplio (‚â•200-250 palabras)**, reiterando datos esenciales, marcas involucradas y fundamentos invocados, con redacci√≥n solemne y clara.

9. **CIERRE**  
   - ‚Äú**Tegucigalpa M.D.C., [FECHA]**‚Äù  
   - L√≠nea de **firma**  
   - **ANEXOS** (lista)

---

## ‚úçÔ∏è REQUISITOS DE REDACCI√ìN Y EXTENSI√ìN

- Estilo **formal, t√©cnico y persuasivo** (registro forense hondure√±o).  
- Producir un documento **extenso** (objetivo: **equivalente a 6-10 p√°ginas**).  
- **Cada secci√≥n** relevante con **p√°rrafos largos**; evita listas en **PETICI√ìN**.  
- **Hechos/Refutaciones** obligatoriamente enumerados (PRIMERO, SEGUNDO‚Ä¶).  
- **Fundamentos** con citas **expl√≠citas** (norma, art√≠culo, numeral y **cita textual** cuando el DB lo permita).  
- **No inventes** citas ni art√≠culos; si el DB no trae texto, ind√≠calo y explica la norma de forma razonada.  
- Mant√©n **t√≠tulos en espa√±ol y en MAY√öSCULAS**.  
- **No entregar res√∫menes** ni ‚Äúmodelos cortos‚Äù.

---

## üåê INVESTIGACI√ìN EN INTERNET (CUANDO PROCEDA)

- Para **notoriedad/comercializaci√≥n/uso**: utiliza **\`searchWeb\`**, muestra **URLs planas** y sugiere anexarlas.  
- Si \`searchLegalBasis\` fuera insuficiente para doctrina/jurisprudencia: **complementa con \`searchWeb\`** y **deja claro** que es fuente externa.

---

## ‚úÖ VERIFICACIONES FINALES (CHECKLIST)

- ¬øSe us√≥ **\`searchLegalBasis\`** en los puntos A y B?  
- ¬øSe integraron **art√≠culos con cita textual/par√°frasis** y pertinencia?  
- ¬øHechos/Refutaciones** enumerados** y **extensos**?  
- ¬ø**PETICI√ìN** en **un solo p√°rrafo** y **amplia**?  
- ¬ø**P√ÅRRAFO INICIAL** en may√∫sculas y **al inicio**?  
- ¬ø**Cierre** con Tegucigalpa M.D.C., fecha, firma y **anexos**?  
- ¬øSin secci√≥n llamada **‚ÄúOrden de an√°lisis‚Äù**?

  `;
;

  try {
    const assistant = await openai.beta.assistants.create({
      name: "Legal Drafting Assistant (8/22)",
      instructions: systemPrompt,
      model: "gpt-4o",
      tools: [
        {
          type: "function",
          function: {
            name: "searchLegalBasis",
            description: "Searches for relevant legal texts based on keywords and country",
            parameters: {
              type: "object",
              properties: {
                keywords: {
                  type: "string",
                  description: "Keywords to search legal content for",
                },
                country: {
                  type: "string",
                  description: "Country to restrict the legal search (e.g., El Salvador)",
                },
              },
              required: ["keywords", "country"],
            },
          },
        },
        {
          type: "function",
          function: {
            name: "searchWeb",
            description: "Performs a web search using Bing via searchapi.io",
            parameters: {
              type: "object",
              properties: {
                query: {
                  type: "string",
                  description: "The search query to look up on the web",
                },
                location: {
                  type: "string",
                  description: "Optional location for more localized results (e.g. Tegucigalpa, Honduras)",
                },
              },
              required: ["query"],
            },
          }
        }
      ],
    });

    res.json({ message: "Assistant Created Successfully", id: assistant.id });
  } catch (error) {
    console.error("Assistant Creation Failed:", error.response?.data || error.message);
    res.status(500).send("Assistant Creation Failed");
  }
});

// ---------------------------
//  /api/chat
// ---------------------------
app.post("/api/chat", async (req, res) => {
  const { query, threadID, userID } = req.body;
  let currentThreadID = threadID;

  try {
    // Create thread if needed
    if (!currentThreadID) {
      const thread = await openai.beta.threads.create();
      currentThreadID = thread.id;
      const title = query.length > 50 ? query.slice(0, 47) + "..." : query;

      const { error } = await supabase
        .from("chat_threads")
        .insert([
          {
            user_id: userID,
            title,
            thread_id: currentThreadID,
          },
        ])
        .select();

      if (error) throw new Error("Supabase thread insert failed");
    }

    // Send user message
    await openai.beta.threads.messages.create(currentThreadID, {
      role: "user",
      content: query,
    });

    // Run the assistant
    let run = await openai.beta.threads.runs.createAndPoll(currentThreadID, {
      assistant_id: ASSISTANT_ID,
    });

    // If tool calls detected
    if (run.status === "requires_action" && run.required_action?.type === "submit_tool_outputs") {
      console.log("Detected tool call(s)");

      const toolCalls = run.required_action.submit_tool_outputs.tool_calls;

      const toolOutputs = await Promise.all(
        toolCalls.map(async (toolCall) => {
          const functionName = toolCall.function.name;
          const args = JSON.parse(toolCall.function.arguments);
          let result;

          // Route to correct function
          switch (functionName) {
            case "searchLegalBasis": // alias for searchMeili
              result = await searchMeili(args.keywords, args.country);
              break;

            case "searchWeb":
              result = await searchWeb(args); // no redeclaration
              break;

            default:
              console.warn(`Unknown function: ${functionName}`);
              result = `Error: Function "${functionName}" not implemented`;
          }

          return {
            tool_call_id: toolCall.id,
            output: typeof result === "string" ? result : JSON.stringify(result),
          };
        })
      );

      console.log("Tool outputs", toolOutputs);

      // Submit tool outputs
      run = await openai.beta.threads.runs.submitToolOutputsAndPoll(currentThreadID, run.id, {
        tool_outputs: toolOutputs,
      });
    }

    // Return final assistant message
    if (run.status === "completed") {
      const messages = await openai.beta.threads.messages.list(currentThreadID);
      const final = messages.data[0].content[0].text.value;
      await supabase
        .from("chat_threads")
        .update({ updated_at: new Date() })
        .eq("thread_id", currentThreadID);

      return res.json({ response: final, threadID: currentThreadID });
    } else {
      return res.status(500).send("Run did not complete.");
    }
  } catch (err) {
    console.error("Chat error:", err.response?.data || err.message);
    return res.status(500).send("Something went wrong.");
  }
});

// ---------------------------
//  /api/get-thread-history
// ---------------------------
app.post("/api/get-thread-history", async (req, res) => {
  const { threadId } = req.body;

  try {
    const messages = await openai.beta.threads.messages.list(threadId);
    const cleanMessages = messages.data.map((msg) => {
      let content = "";

      if (msg.content?.[0]?.type === "text") {
        content = msg.content[0].text.value;
      }

      return {
        id: msg.id,
        role: msg.role,
        content,
      };
    });

    res.json({ messages: cleanMessages });
  } catch (error) {
    console.error("Thread history error:", error.response?.data || error.message);
    res.status(500).send("Failed to get thread history");
  }
});



app.post("/api/searchWeb", async (req, res) => {
  const { query, location } = req.body;

  if (!query) {
    return res.status(400).json({ error: "Query is required" });
  }

  const result = await searchWeb({ query, location });
  res.send(result);
});

// ---------------------------
//  /api/generate-legal-document
// ---------------------------
app.post("/api/generate-legal-document", async (req, res) => {
  const { query, threadID, userID, documentType, country = "Honduras" } = req.body;
  let currentThreadID = threadID;

  try {
    // Create thread if needed
    if (!currentThreadID) {
      const thread = await openai.beta.threads.create();
      currentThreadID = thread.id;
      const title = `Legal Document: ${documentType || 'Draft'}`;

      const { error } = await supabase
        .from("chat_threads")
        .insert([
          {
            user_id: userID,
            title,
            thread_id: currentThreadID,
          },
        ])
        .select();

      if (error) throw new Error("Supabase thread insert failed");
    }

    // Step 1: Research and Analysis Phase
    const researchPrompt = `INICIA FASE DE INVESTIGACI√ìN Y AN√ÅLISIS JUR√çDICO

Para el siguiente caso: ${query}

Documento: ${documentType}

REALIZA LOS SIGUIENTES PASOS:

1. **B√öSQUEDA LEGAL OBLIGATORIA**: Usa searchLegalBasis para encontrar:
   - Art√≠culos relevantes de la Ley de Propiedad Industrial de ${country}
   - Tratados internacionales aplicables (Convenio de Par√≠s, ADPIC, etc.)
   - Jurisprudencia y doctrina relacionada
   - Manual Armonizado de Criterios en Materia de Marcas

2. **AN√ÅLISIS JUR√çDICO DETALLADO**: 
   - Identifica todos los fundamentos legales aplicables
   - Analiza los hechos desde m√∫ltiples perspectivas jur√≠dicas
   - Identifica argumentos adicionales que fortalezcan el caso
   - Sugiere pruebas y evidencias que podr√≠an presentarse

3. **ESTRUCTURA DOCUMENTAL COMPLETA**:
   - Define la estructura detallada del documento (m√≠nimo 8 secciones principales)
   - Para cada secci√≥n, especifica qu√© contenido debe incluir
   - Establece la extensi√≥n objetivo para cada secci√≥n

4. **CONFIRMACI√ìN DE DATOS**:
   - Lista todos los datos que necesitas del usuario
   - Solicita informaci√≥n adicional que podr√≠a fortalecer el caso

OBJETIVO: Generar un an√°lisis jur√≠dico exhaustivo que sirva como base para un documento de 6-10 p√°ginas.`;

    await openai.beta.threads.messages.create(currentThreadID, {
      role: "user",
      content: researchPrompt,
    });

    let run = await openai.beta.threads.runs.createAndPoll(currentThreadID, {
      assistant_id: ASSISTANT_ID,
    });

    // Handle tool calls for research phase
    if (run.status === "requires_action" && run.required_action?.type === "submit_tool_outputs") {
      const toolCalls = run.required_action.submit_tool_outputs.tool_calls;
      const toolOutputs = await Promise.all(
        toolCalls.map(async (toolCall) => {
          const functionName = toolCall.function.name;
          const args = JSON.parse(toolCall.function.arguments);
          let result;

          switch (functionName) {
            case "searchLegalBasis":
              result = await searchMeili(args.keywords, args.country);
              break;
            case "searchWeb":
              result = await searchWeb(args);
              break;
            default:
              result = `Error: Function "${functionName}" not implemented`;
          }

          return {
            tool_call_id: toolCall.id,
            output: typeof result === "string" ? result : JSON.stringify(result),
          };
        })
      );

      run = await openai.beta.threads.runs.submitToolOutputsAndPoll(currentThreadID, run.id, {
        tool_outputs: toolOutputs,
      });
    }

    // Step 2: Document Drafting Phase
    const draftingPrompt = `INICIA FASE DE REDACCI√ìN DEL DOCUMENTO COMPLETO

Bas√°ndote en la investigaci√≥n anterior, procede a redactar el documento legal completo.

REQUISITOS OBLIGATORIOS:

1. **EXTENSI√ìN M√çNIMA**: El documento debe tener al menos 6-10 p√°ginas equivalentes (aproximadamente 3000-5000 palabras)

2. **ESTRUCTURA DETALLADA**:
   - P√ÅRRAFO INICIAL DE RESUMEN (‚â•200 palabras)
   - COMPARECENCIA (extensa, con todos los datos del abogado)
   - ANTECEDENTES (desarrollo amplio, ‚âà1 p√°gina)
   - HECHOS/REFUTACIONES (enumerados, cada uno ‚â•200 palabras)
   - FUNDAMENTOS DE DERECHO (muy desarrollada, ‚â•2 p√°ginas)
   - PETICI√ìN (un p√°rrafo amplio, ‚â•250 palabras)
   - CIERRE Y ANEXOS

3. **CONTENIDO RICO**:
   - Integra TODOS los art√≠culos encontrados en la investigaci√≥n
   - Incluye citas textuales cuando est√©n disponibles
   - Desarrolla argumentos desde m√∫ltiples perspectivas
   - A√±ade an√°lisis jur√≠dico detallado en cada secci√≥n

4. **ESTILO Y FORMATO**:
   - Lenguaje formal y t√©cnico
   - P√°rrafos extensos y bien desarrollados
   - Enumeraci√≥n clara de hechos y fundamentos
   - Citas apropiadas y referencias

5. **VERIFICACI√ìN DE EXTENSI√ìN**:
   - Al final, confirma la extensi√≥n del documento
   - Si es menor a 6 p√°ginas, identifica secciones que necesitan expansi√≥n
   - Expande las secciones m√°s importantes (Fundamentos de Derecho, Hechos, Antecedentes)

REDACTAR EL DOCUMENTO COMPLETO AHORA.`;

    await openai.beta.threads.messages.create(currentThreadID, {
      role: "user",
      content: draftingPrompt,
    });

    run = await openai.beta.threads.runs.createAndPoll(currentThreadID, {
      assistant_id: ASSISTANT_ID,
    });

    // Handle tool calls for drafting phase
    if (run.status === "requires_action" && run.required_action?.type === "submit_tool_outputs") {
      const toolCalls = run.required_action.submit_tool_outputs.tool_calls;
      const toolOutputs = await Promise.all(
        toolCalls.map(async (toolCall) => {
          const functionName = toolCall.function.name;
          const args = JSON.parse(toolCall.function.arguments);
          let result;

          switch (functionName) {
            case "searchLegalBasis":
              result = await searchMeili(args.keywords, args.country);
              break;
            case "searchWeb":
              result = await searchWeb(args);
              break;
            default:
              result = `Error: Function "${functionName}" not implemented`;
          }

          return {
            tool_call_id: toolCall.id,
            output: typeof result === "string" ? result : JSON.stringify(result),
          };
        })
      );

      run = await openai.beta.threads.runs.submitToolOutputsAndPoll(currentThreadID, run.id, {
        tool_outputs: toolOutputs,
      });
    }

    // Step 3: Review and Enhancement Phase
    const reviewPrompt = `FASE FINAL: REVISI√ìN Y MEJORA DEL DOCUMENTO

REALIZA UNA REVISI√ìN EXHAUSTIVA DEL DOCUMENTO GENERADO:

1. **VERIFICACI√ìN DE EXTENSI√ìN**:
   - Cuenta las palabras del documento
   - Si es menor a 3000 palabras, identifica secciones que necesitan expansi√≥n
   - Expande las secciones m√°s importantes (Fundamentos de Derecho, Hechos, Antecedentes)

2. **MEJORAS DE CONTENIDO**:
   - A√±ade argumentos jur√≠dicos adicionales
   - Incluye m√°s citas y referencias legales
   - Desarrolla mejor los an√°lisis de confundibilidad
   - A√±ade consideraciones sobre el consumidor medio
   - Incluye an√°lisis de canales de comercializaci√≥n

3. **ESTRUCTURA Y COHERENCIA**:
   - Verifica que todas las secciones est√©n completas
   - Asegura que los argumentos fluyan l√≥gicamente
   - Confirma que la petici√≥n sea clara y completa

4. **LENGUAJE Y ESTILO**:
   - Verifica el uso de lenguaje formal y t√©cnico
   - Asegura que los p√°rrafos sean extensos y bien desarrollados
   - Confirma el uso apropiado de citas y referencias

SI EL DOCUMENTO NO ALCANZA LA EXTENSI√ìN OBJETIVO, EXP√ÅNDELO SIGNIFICATIVAMENTE.

ENTREGA EL DOCUMENTO FINAL COMPLETO Y MEJORADO.`;

    await openai.beta.threads.messages.create(currentThreadID, {
      role: "user",
      content: reviewPrompt,
    });

    run = await openai.beta.threads.runs.createAndPoll(currentThreadID, {
      assistant_id: ASSISTANT_ID,
    });

    // Handle tool calls for review phase
    if (run.status === "requires_action" && run.required_action?.type === "submit_tool_outputs") {
      const toolCalls = run.required_action.submit_tool_outputs.tool_calls;
      const toolOutputs = await Promise.all(
        toolCalls.map(async (toolCall) => {
          const functionName = toolCall.function.name;
          const args = JSON.parse(toolCall.function.arguments);
          let result;

          switch (functionName) {
            case "searchLegalBasis":
              result = await searchMeili(args.keywords, args.country);
              break;
            case "searchWeb":
              result = await searchWeb(args);
              break;
            default:
              result = `Error: Function "${functionName}" not implemented`;
          }

          return {
            tool_call_id: toolCall.id,
            output: typeof result === "string" ? result : JSON.stringify(result),
          };
        })
      );

      run = await openai.beta.threads.runs.submitToolOutputsAndPoll(currentThreadID, run.id, {
        tool_outputs: toolOutputs,
      });
    }

    // Return final document
    if (run.status === "completed") {
      const messages = await openai.beta.threads.messages.list(currentThreadID);
      const final = messages.data[0].content[0].text.value;
      
      await supabase
        .from("chat_threads")
        .update({ updated_at: new Date() })
        .eq("thread_id", currentThreadID);

      return res.json({ 
        response: final, 
        threadID: currentThreadID,
        documentType: documentType,
        generationMethod: "agentic-multi-step"
      });
    } else {
      return res.status(500).send("Document generation did not complete.");
    }
  } catch (err) {
    console.error("Document generation error:", err.response?.data || err.message);
    return res.status(500).send("Something went wrong during document generation.");
  }
});

// ---------------------------
app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
});
